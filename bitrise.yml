format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: ios

trigger_map:
  - push_branch: main
    workflow: primary
  - push_branch: master
    workflow: primary
  - tag: v*.*.*
    workflow: deploy

workflows:
  primary:
    steps:
      - activate-ssh-key@4:
          run_if: "{{setup_ssh_key}}"
      - git-clone@6: {}
      - cache-pull@2: {}
      - script@1:
          title: Install Dependencies
          inputs:
            - content: |-
                #!/bin/bash
                set -ex
                bundle install
      - script@1:
          title: Run Fastlane CI Build
          inputs:
            - content: |-
                #!/bin/bash --login -eo pipefail
                bundle exec fastlane ios ci_build
      - cache-push@2: {}
      - deploy-to-bitrise-io@2: {}

  deploy:
    steps:
      - activate-ssh-key@4:
          run_if: "{{setup_ssh_key}}"
      - git-clone@6: {}
      - cache-pull@2: {}
      - script@1:
          title: Install Dependencies
          inputs:
            - content: |-
                #!/bin/bash
                set -ex
                bundle install
      - script@1:
          title: Run Fastlane Release
          inputs:
            - content: |-
                #!/bin/bash --login -eo pipefail
                bundle exec fastlane ios ci_release
      - cache-push@2: {}
      - deploy-to-bitrise-io@2: {}

meta:
  bitrise.io:
    stack: osx-xcode-15.2.x
    machine_type_id: g2-m1.8core
